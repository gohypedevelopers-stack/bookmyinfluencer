generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  name              String?
  email             String             @unique
  passwordHash      String?
  image             String?
  role              UserRole           @default(INFLUENCER)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastSeenAt        DateTime?
  auditLogs         AuditLog[]
  blocksReceived    Block[]            @relation("BlocksReceived")
  blocksInitiated   Block[]            @relation("BlocksInitiated")
  brandProfile      BrandProfile?
  influencerProfile InfluencerProfile?
  sentMessages      Message[]          @relation("SentMessages")
  notifications     Notification[]
  reportsReceived   Report[]           @relation("ReportsReceived")
  reportsInitiated  Report[]           @relation("ReportsInitiated")
}

model BrandProfile {
  id          String     @id @default(cuid())
  userId      String     @unique
  companyName String
  website     String?
  industry    String?
  description String?
  location    String?
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaigns   Campaign[]
  contracts   Contract[]
}

model InfluencerProfile {
  id              String              @id @default(cuid())
  userId          String              @unique
  niche           String
  location        String?
  bio             String?
  instagramHandle String?
  youtubeHandle   String?
  tiktokHandle    String?
  followers       Int                 @default(0)
  engagementRate  Float               @default(0)
  socialData      String?
  pricing         String?
  applications    CampaignCandidate[]
  contracts       Contract[]
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  kyc             KYCSubmission?
  payouts         PayoutRequest[]
}

model KYCSubmission {
  id              String            @id @default(cuid())
  profileId       String            @unique
  status          KYCStatus         @default(NOT_SUBMITTED)
  documentType    String?
  documentUrl     String?
  documentBackUrl String?
  panCard         String?
  bankDetails     String?
  submittedAt     DateTime?
  reviewedAt      DateTime?
  adminNotes      String?
  profile         InfluencerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model Campaign {
  id           String              @id @default(cuid())
  brandId      String
  title        String
  description  String?
  requirements String?
  budget       Float?
  status       CampaignStatus      @default(DRAFT)
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  images       String[]            @default([])
  location     String?
  minFollowers Int?                @default(0)
  niche        String?
  paymentType  String?             @default("FIXED")
  brand        BrandProfile        @relation(fields: [brandId], references: [id])
  candidates   CampaignCandidate[]
}

model CampaignCandidate {
  id           String            @id @default(cuid())
  campaignId   String
  influencerId String
  status       CandidateStatus   @default(CONTACTED)
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  campaign     Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  influencer   InfluencerProfile @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  chatThread   ChatThread?
  contract     Contract?
  offer        Offer?

  @@unique([campaignId, influencerId])
}

model Offer {
  id                      String            @id @default(cuid())
  candidateId             String            @unique
  amount                  Float
  currency                String            @default("INR")
  deliverablesDescription String
  status                  OfferStatus       @default(PENDING)
  history                 String?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  candidate               CampaignCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
}

model Contract {
  id           String              @id @default(cuid())
  candidateId  String?             @unique
  brandId      String
  influencerId String
  totalAmount  Float
  platformFee  Float
  taxAmount    Float               @default(0)
  status       ContractStatus      @default(DRAFT)
  startDate    DateTime?
  endDate      DateTime?
  terms        String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  brand        BrandProfile        @relation(fields: [brandId], references: [id])
  candidate    CampaignCandidate?  @relation(fields: [candidateId], references: [id])
  influencer   InfluencerProfile   @relation(fields: [influencerId], references: [id])
  deliverables Deliverable[]
  disputes     Dispute[]
  transactions EscrowTransaction[]
}

model Deliverable {
  id              String            @id @default(cuid())
  contractId      String
  title           String
  description     String?
  dueDate         DateTime?
  status          DeliverableStatus @default(PENDING)
  submissionUrl   String?
  submissionNotes String?
  submittedAt     DateTime?
  approvedAt      DateTime?
  feedback        String?
  contract        Contract          @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model EscrowTransaction {
  id                String                  @id @default(cuid())
  contractId        String
  amount            Float
  currency          String                  @default("INR")
  type              String
  status            EscrowTransactionStatus @default(PENDING)
  paymentGatewayRef String?
  invoiceUrl        String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  contract          Contract                @relation(fields: [contractId], references: [id])
}

model PayoutRequest {
  id            String            @id @default(cuid())
  influencerId  String
  amount        Float
  currency      String            @default("INR")
  status        PayoutStatus      @default(REQUESTED)
  bankReference String?
  adminNotes    String?
  requestedAt   DateTime          @default(now())
  processedAt   DateTime?
  influencer    InfluencerProfile @relation(fields: [influencerId], references: [id])
}

model ChatThread {
  id           String             @id @default(cuid())
  candidateId  String?            @unique
  participants String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  initiatedBy  String?
  candidate    CampaignCandidate? @relation(fields: [candidateId], references: [id])
  messages     Message[]
}

model Message {
  id             String        @id @default(cuid())
  threadId       String
  senderId       String
  content        String?
  read           Boolean       @default(false)
  status         MessageStatus @default(SENT)
  deliveredAt    DateTime?
  seenAt         DateTime?
  createdAt      DateTime      @default(now())
  attachmentType String?
  attachmentUrl  String?
  sender         User          @relation("SentMessages", fields: [senderId], references: [id])
  thread         ChatThread    @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

model Dispute {
  id          String        @id @default(cuid())
  contractId  String
  raiserId    String
  reason      String
  description String
  status      DisputeStatus @default(OPEN)
  resolution  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  contract    Contract      @relation(fields: [contractId], references: [id])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  blocked   User     @relation("BlocksReceived", fields: [blockedId], references: [id])
  blocker   User     @relation("BlocksInitiated", fields: [blockerId], references: [id])

  @@unique([blockerId, blockedId])
}

model Report {
  id         String   @id @default(cuid())
  reporterId String
  reportedId String
  reason     String
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())
  reported   User     @relation("ReportsReceived", fields: [reportedId], references: [id])
  reporter   User     @relation("ReportsInitiated", fields: [reporterId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String
  details   String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model OtpUser {
  id         String    @id @default(uuid())
  email      String    @unique
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  creator    Creator?
  otps       EmailOtp?

  @@map("users")
}

model EmailOtp {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  otpHash    String   @map("otp_hash")
  expiresAt  DateTime @map("expires_at")
  attempts   Int      @default(0)
  lastSentAt DateTime @default(now()) @map("last_sent_at")
  createdAt  DateTime @default(now()) @map("created_at")
  user       OtpUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_otps")
}

model Creator {
  id                   String                      @id @default(uuid())
  userId               String                      @unique @map("user_id")
  email                String?                     @map("email")
  fullName             String?                     @map("full_name")
  phone                String?
  niche                String?
  instagramUrl         String?                     @map("instagram_url")
  youtubeUrl           String?                     @map("youtube_url")
  tiktokUrl            String?                     @map("tiktok_url")
  twitchUrl            String?                     @map("twitch_url")
  profileImageUrl      String?                     @map("profile_image_url")
  autoProfileImageUrl  String?                     @map("auto_profile_image_url")
  displayName          String?                     @map("display_name")
  autoDisplayName      String?                     @map("auto_display_name")
  bio                  String?
  autoBio              String?                     @map("auto_bio")
  pricing              String?
  mediaKit             String?                     @map("media_kit")
  rawSocialData        String?                     @map("raw_social_data")
  lastYoutubeFetchAt   DateTime?                   @map("last_youtube_fetch_at")
  lastInstagramFetchAt DateTime?                   @map("last_instagram_fetch_at")
  lastTiktokFetchAt    DateTime?                   @map("last_tiktok_fetch_at")
  lastTwitchFetchAt    DateTime?                   @map("last_twitch_fetch_at")
  verifiedAt           DateTime?                   @map("verified_at")
  notificationSettings String?                     @map("notification_settings")
  backgroundImageUrl   String?                     @map("background_image_url")
  paymentHistory       String?                     @map("payment_history")
  payoutMethods        String?                     @map("payout_methods")
  isLiveSyncEnabled    Boolean                     @default(true) @map("is_live_sync_enabled")
  verificationStatus   KYCStatus                   @default(NOT_SUBMITTED) @map("verification_status")
  kycSubmission        CreatorKYCSubmission?
  metrics              CreatorMetric[]
  selfReportedMetrics  CreatorSelfReportedMetric[]
  socialAccounts       CreatorSocialAccount[]
  user                 OtpUser                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("creators")
}

model CreatorSocialAccount {
  id           String    @id @default(uuid())
  creatorId    String    @map("creator_id")
  provider     String
  providerId   String    @map("provider_id")
  accessToken  String?   @map("access_token")
  refreshToken String?   @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")
  username     String?
  type         String    @default("OAUTH")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  creator      Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([creatorId, provider])
  @@map("creator_social_accounts")
}

model CreatorSelfReportedMetric {
  id             String   @id @default(uuid())
  creatorId      String   @map("creator_id")
  provider       String
  followersCount Int      @map("followers_count")
  updatedAt      DateTime @updatedAt @map("updated_at")
  creator        Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([creatorId, provider])
  @@map("creator_self_reported_metrics")
}

model CreatorMetric {
  id             String   @id @default(uuid())
  creatorId      String   @map("creator_id")
  provider       String
  date           DateTime @default(now())
  followersCount Int      @default(0) @map("followers_count")
  engagementRate Float    @default(0) @map("engagement_rate")
  viewsCount     String?  @map("views_count")
  mediaCount     Int?     @map("media_count")
  avgLikes       Float?   @map("avg_likes")
  avgComments    Float?   @map("avg_comments")
  reach          Int?
  source         String?  @default("oauth")
  fetchedAt      DateTime @default(now()) @map("fetched_at")
  rawResponse    String?  @map("raw_response")
  creator        Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, provider, date])
  @@map("creator_metrics")
}

model CreatorKYCSubmission {
  id                 String    @id @default(uuid())
  creatorId          String    @unique @map("creator_id")
  status             KYCStatus @default(PENDING)
  instagramFollowers Int?      @map("instagram_followers")
  youtubeSubscribers Int?      @map("youtube_subscribers")
  totalPosts         Int?      @map("total_posts")
  engagementRate     Float?    @map("engagement_rate")
  adminNotes         String?   @map("admin_notes")
  reviewedBy         String?   @map("reviewed_by")
  reviewedAt         DateTime? @map("reviewed_at")
  submittedAt        DateTime  @default(now()) @map("submitted_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  creator            Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@map("creator_kyc_submissions")
}

enum UserRole {
  BRAND
  INFLUENCER
  ADMIN
}

enum KYCStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum CandidateStatus {
  CONTACTED
  IN_NEGOTIATION
  OFFERED
  HIRED
  CONTENT_REVIEW
  COMPLETED
  REJECTED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  COUNTERED
}

enum ContractStatus {
  DRAFT
  PENDING_ESCROW
  ACTIVE
  COMPLETED
  CANCELLED
  DISPUTED
}

enum DeliverableStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
}

enum EscrowTransactionStatus {
  PENDING
  FUNDED
  RELEASED
  REFUNDED
  DISPUTED
}

enum PayoutStatus {
  REQUESTED
  PROCESSING
  PAID
  FAILED
}

enum DisputeStatus {
  OPEN
  RESOLVED_REFUND
  RESOLVED_RELEASE
  CLOSED
}

enum MessageStatus {
  SENT
  DELIVERED
  SEEN
}
