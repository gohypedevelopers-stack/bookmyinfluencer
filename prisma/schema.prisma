generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
  engineType    = "binary"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String               @id @default(cuid())
  name              String?
  email             String               @unique
  passwordHash      String?
  image             String?
  role              String               @default("INFLUENCER")
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  lastSeenAt        DateTime?
  auditLogs         AuditLog[]
  blocksReceived    Block[]              @relation("BlocksReceived")
  blocksInitiated   Block[]              @relation("BlocksInitiated")
  brandProfile      BrandProfile?
  managedCampaigns  CampaignAssignment[]
  influencerProfile InfluencerProfile?
  sentMessages      Message[]            @relation("SentMessages")
  notifications     Notification[]
  reportsReceived   Report[]             @relation("ReportsReceived")
  reportsInitiated  Report[]             @relation("ReportsInitiated")
}

model BrandProfile {
  id             String       @id @default(cuid())
  userId         String       @unique
  companyName    String
  website        String?
  industry       String?
  description    String?
  location       String?
  paymentMethods String?      @default("[]")
  walletBalance  Float        @default(0)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  brandWallet    BrandWallet?
  campaigns      Campaign[]
  contracts      Contract[]
  
  // Onboarding Data
  onboardingCompleted  Boolean @default(false)
  campaignType         String? // Store as JSON string
  campaignBudget       String?
  targetPlatforms      String? // Store as JSON string
  preferredCreatorType String?
  campaignGoals        String?

  // Creator Matching Preferences
  minFollowers      Int?
  maxFollowers      Int?
  minPricePerPost   Float?
  maxPricePerPost   Float?
  priceType         String?      @default("Per Post")
}

model InfluencerProfile {
  id              String              @id @default(cuid())
  userId          String              @unique
  niche           String
  location        String?
  bio             String?
  instagramHandle String?
  youtubeHandle   String?
  tiktokHandle    String?
  followers       Int                 @default(0)
  engagementRate  Float               @default(0)
  socialData      String?
  pricing         String?
  price           Int?
  priceStory      Int?
  pricePost       Int?
  priceCollab     Int?
  priceType       String?             @default("Per Post")
  applications    CampaignCandidate[]
  contracts       Contract[]
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  kyc             KYCSubmission?
  payoutRecords   PayoutRecord[]
  payouts         PayoutRequest[]

  // Onboarding Data
  onboardingCompleted Boolean @default(false)
  platforms           String? // Store as JSON string
}

model KYCSubmission {
  id                String            @id @default(cuid())
  profileId         String            @unique
  status            String         @default("NOT_SUBMITTED")
  documentType      String?
  documentUrl       String?
  documentBackUrl   String?
  panCard           String?
  bankDetails       String?
  submittedAt       DateTime?
  reviewedAt        DateTime?
  adminNotes        String?
  livenessPrompt    String?
  livenessResult    String?
  selfieCapturedAt  DateTime?
  selfieImageKey    String?
  verifiedByAdminAt DateTime?
  profile           InfluencerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model Campaign {
  id           String              @id @default(cuid())
  brandId      String
  title        String
  description  String?
  requirements String?
  budget       Float?
  status       String      @default("DRAFT")
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  images       String              @default("[]")
  location     String?
  minFollowers Int?                @default(0)
  niche        String?
  paymentType  String?             @default("FIXED")
  brand        BrandProfile        @relation(fields: [brandId], references: [id])
  assignment   CampaignAssignment?
  candidates   CampaignCandidate[]
  payouts      PayoutRecord[]
  transactions WalletTransaction[]
}

model CampaignCandidate {
  id           String            @id @default(cuid())
  campaignId   String
  influencerId String
  status       String   @default("CONTACTED")
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  campaign     Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  influencer   InfluencerProfile @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  chatThread   ChatThread?
  contract     Contract?
  offer        Offer?

  @@unique([campaignId, influencerId])
}

model Offer {
  id                      String            @id @default(cuid())
  candidateId             String            @unique
  amount                  Float
  currency                String            @default("INR")
  deliverablesDescription String
  status                  String       @default("PENDING")
  history                 String?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  candidate               CampaignCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
}

model Contract {
  id           String              @id @default(cuid())
  candidateId  String?             @unique
  brandId      String
  influencerId String
  totalAmount  Float
  platformFee  Float
  taxAmount    Float               @default(0)
  status       String      @default("DRAFT")
  startDate    DateTime?
  endDate      DateTime?
  terms        String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  brand        BrandProfile        @relation(fields: [brandId], references: [id])
  candidate    CampaignCandidate?  @relation(fields: [candidateId], references: [id])
  influencer   InfluencerProfile   @relation(fields: [influencerId], references: [id])
  deliverables Deliverable[]
  disputes     Dispute[]
  transactions EscrowTransaction[]
}

model Deliverable {
  id              String            @id @default(cuid())
  contractId      String
  title           String
  description     String?
  dueDate         DateTime?
  status          String @default("PENDING")
  submissionUrl   String?
  submissionNotes String?
  submittedAt     DateTime?
  approvedAt      DateTime?
  feedback        String?
  contract        Contract          @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model EscrowTransaction {
  id                String                  @id @default(cuid())
  contractId        String
  amount            Float
  currency          String                  @default("INR")
  type              String
  status            String @default("PENDING")
  paymentGatewayRef String?
  invoiceUrl        String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  contract          Contract                @relation(fields: [contractId], references: [id])
}

model PayoutRequest {
  id            String            @id @default(cuid())
  influencerId  String
  amount        Float
  currency      String            @default("INR")
  status        String      @default("REQUESTED")
  bankReference String?
  adminNotes    String?
  requestedAt   DateTime          @default(now())
  processedAt   DateTime?
  influencer    InfluencerProfile @relation(fields: [influencerId], references: [id])
}

model ChatThread {
  id           String             @id @default(cuid())
  candidateId  String?            @unique
  participants String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  initiatedBy  String?
  candidate    CampaignCandidate? @relation(fields: [candidateId], references: [id])
  messages     Message[]
}

model Message {
  id             String        @id @default(cuid())
  threadId       String
  senderId       String
  content        String?
  read           Boolean       @default(false)
  createdAt      DateTime      @default(now())
  attachmentType String?
  attachmentUrl  String?
  deliveredAt    DateTime?
  seenAt         DateTime?
  status         String @default("SENT")
  sender         User          @relation("SentMessages", fields: [senderId], references: [id])
  thread         ChatThread    @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

model Dispute {
  id          String        @id @default(cuid())
  contractId  String
  raiserId    String
  reason      String
  description String
  status      String @default("OPEN")
  resolution  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  contract    Contract      @relation(fields: [contractId], references: [id])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  blocked   User     @relation("BlocksReceived", fields: [blockedId], references: [id])
  blocker   User     @relation("BlocksInitiated", fields: [blockerId], references: [id])

  @@unique([blockerId, blockedId])
}

model Report {
  id         String   @id @default(cuid())
  reporterId String
  reportedId String
  reason     String
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())
  reported   User     @relation("ReportsReceived", fields: [reportedId], references: [id])
  reporter   User     @relation("ReportsInitiated", fields: [reporterId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String
  details   String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model OtpUser {
  id         String    @id @default(uuid())
  email      String    @unique
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  creator    Creator?
  otps       EmailOtp?

  @@map("users")
}

model EmailOtp {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  otpHash    String   @map("otp_hash")
  expiresAt  DateTime @map("expires_at")
  attempts   Int      @default(0)
  lastSentAt DateTime @default(now()) @map("last_sent_at")
  createdAt  DateTime @default(now()) @map("created_at")
  user       OtpUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_otps")
}

model Creator {
  id                   String                      @id @default(uuid())
  userId               String                      @unique @map("user_id")
  email                String?                     @map("email")
  fullName             String?                     @map("full_name")
  phone                String?
  niche                String?
  instagramUrl         String?                     @map("instagram_url")
  youtubeUrl           String?                     @map("youtube_url")
  profileImageUrl      String?                     @map("profile_image_url")
  autoProfileImageUrl  String?                     @map("auto_profile_image_url")
  displayName          String?                     @map("display_name")
  autoDisplayName      String?                     @map("auto_display_name")
  bio                  String?
  autoBio              String?                     @map("auto_bio")
  pricing              String?
  price                Int?                        @map("price")
  priceStory           Int?                        @map("price_story")
  pricePost            Int?                        @map("price_post")
  priceCollab          Int?                        @map("price_collab")
  priceType            String?                     @default("Per Post") @map("price_type")
  mediaKit             String?                     @map("media_kit")
  rawSocialData        String?                     @map("raw_social_data")
  lastYoutubeFetchAt   DateTime?                   @map("last_youtube_fetch_at")
  lastInstagramFetchAt DateTime?                   @map("last_instagram_fetch_at")
  verifiedAt           DateTime?                   @map("verified_at")
  backgroundImageUrl   String?                     @map("background_image_url")
  paymentHistory       String?                     @map("payment_history")
  payoutMethods        String?                     @map("payout_methods")
  verificationStatus   String                   @default("NOT_SUBMITTED") @map("verification_status")
  isLiveSyncEnabled    Boolean                     @default(true) @map("is_live_sync_enabled")
  lastTiktokFetchAt    DateTime?                   @map("last_tiktok_fetch_at")
  lastTwitchFetchAt    DateTime?                   @map("last_twitch_fetch_at")
  notificationSettings String?                     @map("notification_settings")
  tiktokUrl            String?                     @map("tiktok_url")
  twitchUrl            String?                     @map("twitch_url")
  kycSubmission        CreatorKYCSubmission?
  metrics              CreatorMetric[]
  selfReportedMetrics  CreatorSelfReportedMetric[]
  socialAccounts       CreatorSocialAccount[]
  user                 OtpUser                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Onboarding Data
  onboardingCompleted Boolean @default(false)
  platforms           String? // Store as JSON string

  @@map("creators")
}

model CreatorSocialAccount {
  id           String    @id @default(uuid())
  creatorId    String    @map("creator_id")
  provider     String
  providerId   String    @map("provider_id")
  accessToken  String?   @map("access_token")
  refreshToken String?   @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")
  username     String?
  type         String    @default("OAUTH")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  creator      Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([creatorId, provider])
  @@map("creator_social_accounts")
}

model CreatorSelfReportedMetric {
  id             String   @id @default(uuid())
  creatorId      String   @map("creator_id")
  provider       String
  followersCount Int      @map("followers_count")
  updatedAt      DateTime @updatedAt @map("updated_at")
  creator        Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([creatorId, provider])
  @@map("creator_self_reported_metrics")
}

model CreatorMetric {
  id             String   @id @default(uuid())
  creatorId      String   @map("creator_id")
  provider       String
  date           DateTime @default(now())
  followersCount Int      @default(0) @map("followers_count")
  engagementRate Float    @default(0) @map("engagement_rate")
  viewsCount     String?  @map("views_count")
  mediaCount     Int?     @map("media_count")
  avgLikes       Float?   @map("avg_likes")
  avgComments    Float?   @map("avg_comments")
  reach          Int?
  source         String?  @default("oauth")
  fetchedAt      DateTime @default(now()) @map("fetched_at")
  rawResponse    String?  @map("raw_response")
  creator        Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, provider, date])
  @@map("creator_metrics")
}

model CreatorKYCSubmission {
  id                 String          @id @default(uuid())
  creatorId          String          @unique @map("creator_id")
  status             String       @default("PENDING")
  instagramFollowers Int?            @map("instagram_followers")
  youtubeSubscribers Int?            @map("youtube_subscribers")
  totalPosts         Int?            @map("total_posts")
  engagementRate     Float?          @map("engagement_rate")
  adminNotes         String?         @map("admin_notes")
  reviewedBy         String?         @map("reviewed_by")
  reviewedAt         DateTime?       @map("reviewed_at")
  submittedAt        DateTime        @default(now()) @map("submitted_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  livenessPrompt     String? @map("liveness_prompt")
  livenessResult     String? @map("liveness_result")
  selfieCapturedAt   DateTime?       @map("selfie_captured_at")
  selfieImageKey     String?         @map("selfie_image_key")
  verifiedByAdminAt  DateTime?       @map("verified_by_admin_at")
  creator            Creator         @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@map("creator_kyc_submissions")
}

model BrandWallet {
  id           String              @id @default(cuid())
  brandId      String              @unique
  balance      Float               @default(0)
  currency     String              @default("INR")
  updatedAt    DateTime            @updatedAt
  brand        BrandProfile        @relation(fields: [brandId], references: [id])
  transactions WalletTransaction[]
}

model WalletTransaction {
  id         String      @id @default(cuid())
  walletId   String
  type       String
  amount     Float
  campaignId String?
  reference  String?
  status     String      @default("SUCCESS")
  createdAt  DateTime    @default(now())
  campaign   Campaign?   @relation(fields: [campaignId], references: [id])
  wallet     BrandWallet @relation(fields: [walletId], references: [id])
}

model RazorpayPayment {
  id        String   @id @default(cuid())
  orderId   String   @unique
  paymentId String?
  signature String?
  amount    Float
  currency  String   @default("INR")
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CampaignAssignment {
  id         String   @id @default(cuid())
  campaignId String   @unique
  managerId  String
  assignedAt DateTime @default(now())
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  manager    User     @relation(fields: [managerId], references: [id])
}

model PayoutRecord {
  id          String            @id @default(cuid())
  campaignId  String
  creatorId   String
  amount      Float
  method      String
  utr         String
  processedBy String?
  paidAt      DateTime          @default(now())
  campaign    Campaign          @relation(fields: [campaignId], references: [id])
  creator     InfluencerProfile @relation(fields: [creatorId], references: [id])
}


